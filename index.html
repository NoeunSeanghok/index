<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple QR Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; display:flex; flex-direction:column; align-items:center; gap:12px; padding:16px; }
    #video { width: 100%; max-width:480px; border-radius:10px; background:#000; }
    #canvas { display:none; } /* hidden processing canvas */
    #output { max-width:480px; width:100%; word-break:break-word; padding:10px; border-radius:8px; background:#f3f3f3; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:6px; cursor:pointer; }
    .small { font-size:0.9rem; color:#555; }
  </style>
</head>
<body>
  <h2>Simple QR Scanner</h2>

  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="controls">
    <button id="startBtn">Start Camera</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="switchBtn" disabled>Switch Camera</button>
  </div>

  <div id="output" class="small">Status: Idle</div>

  <!-- jsQR library (small, fast QR decoder) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const output = document.getElementById('output');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const switchBtn = document.getElementById('switchBtn');

    let stream = null;
    let scanning = false;
    let useFacingMode = 'environment'; // 'environment' for rear camera on mobile
    let track = null;
    const ctx = canvas.getContext('2d');

    async function startCamera() {
      if (stream) stopCamera();

      try {
        const constraints = {
          video: {
            facingMode: useFacingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];

        await video.play();
        scanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        switchBtn.disabled = false;
        output.textContent = 'Status: Camera started â€” looking for QR codes...';
        tick(); // start processing frames
      } catch (err) {
        console.error(err);
        output.textContent = 'Error: ' + (err.message || err.name);
      }
    }

    function stopCamera() {
      scanning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      switchBtn.disabled = true;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        track = null;
      }
      video.pause();
      video.srcObject = null;
      output.textContent = 'Status: Stopped.';
    }

    async function switchCamera() {
      // Toggle between 'user' and 'environment'
      useFacingMode = (useFacingMode === 'environment') ? 'user' : 'environment';
      output.textContent = 'Status: Switching camera...';
      await startCamera();
    }

    function tick() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // Set canvas size to video size (small scale for faster processing)
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const scale = 0.6; // reduce resolution to speed up scanning
        canvas.width = Math.floor(vw * scale);
        canvas.height = Math.floor(vh * scale);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Use jsQR to detect QR code
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'attemptBoth'
        });

        if (code) {
          // Draw a green bounding box (for debugging)
          drawBoundingBox(code.location);
          // Found data
          output.innerHTML = `<strong>QR found:</strong> ${escapeHtml(code.data)}`;
          // Optionally stop scanning after a successful read:
          // stopCamera(); 
          // or keep scanning by not stopping (maybe you want to detect new codes)
        } else {
          output.textContent = 'Status: Scanning... (no QR found yet)';
        }
      }

      // repeat
      requestAnimationFrame(tick);
    }

    function drawBoundingBox(loc) {
      const scale = canvas.width / video.videoWidth;
      ctx.strokeStyle = 'lime';
      ctx.lineWidth = 3;
      ctx.beginPath();
      if (loc.topLeftCorner) {
        ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        ctx.lineTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
      }
      ctx.stroke();
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, ch => {
        const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' };
        return map[ch];
      });
    }

    // Button handlers
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    switchBtn.addEventListener('click', switchCamera);

    // Auto-start if permission already granted (optional)
    // navigator.permissions?.query({ name: 'camera' }).then(p => {
    //   if (p.state === 'granted') startCamera();
    // });
  </script>
</body>
</html>
